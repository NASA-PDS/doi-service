# ğŸƒâ€â™€ï¸ Continuous Integration and Delivery: Branch Testing
# ======================================================


---

name: ğŸ” Branch integration testing


# Driving Event
# -------------
#
# What event starts this workflow: a push to any branch other than main

on:
    push:
        branches:
            -   '**'
            -   '!main'


# What to Do
# ----------
#
# Test the software with tox

jobs:
    branch-testing:
        name: ğŸªµ Branch Testing
        runs-on: ubuntu-latest
        if: github.actor != 'pdsen-ci'

        steps:
            -
                name: ğŸ’µ Python Cache
                uses: actions/cache@v2
                with:
                    path: ~/.cache/pip
                    # The "key" used to indicate a set of cached files is the operating system runner
                    # plus "py" for Python-specific builds, plus a hash of the wheels, plus "pds" because
                    # we pds-prefix everything with "pds" in PDS! ğŸ˜…
                    key: pds-${{runner.os}}-py-${{hashFiles('**/*.whl')}}
                    # To restore a set of files, we only need to match a prefix of the saved key.
                    restore-keys: pds-${{runner.os}}-py-
            -
                name: Update default configuration
                run: |
                    import sys
                    import os
                    print("Running python version {}".format(sys.version))
                    conf_file = "pds_doi_service.ini"
                    print("Create config file for unit test {}".format(conf_file))
                    with open(conf_file, "w") as f:
                        f.write("[OSTI]\n")
                        f.write("user = {}\n".format("${{secrets.osti_login}}"))
                        f.write("password = {}\n".format("${{secrets.osti_password}}"))
                shell: python
            -
                name: ğŸ©º Test Software
                run:
                    pip install --editable '.[dev]'
                    tox
